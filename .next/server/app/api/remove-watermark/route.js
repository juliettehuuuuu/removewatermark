"use strict";(()=>{var e={};e.id=363,e.ids=[363],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{e.exports=require("punycode")},27910:e=>{e.exports=require("stream")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{e.exports=require("tls")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{e.exports=require("zlib")},75502:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>y,routeModule:()=>g,serverHooks:()=>x,workAsyncStorage:()=>w,workUnitAsyncStorage:()=>v});var a={};t.r(a),t.d(a,{POST:()=>h});var i=t(96559),n=t(48088),s=t(37719),o=t(32190),u=t(64216),p=t(34386),l=t(11288),c=t(45558);let m=new Map;async function d(e){try{let r=e.headers.get("x-forwarded-for"),t=e.headers.get("x-real-ip"),a=e.headers.get("cf-connecting-ip"),i=e.headers.get("x-client-ip");if(a)return a;if(t)return t;if(r)return r.split(",")[0].trim();if(i)return i;return"unknown"}catch{return"unknown"}}async function f(e){new Response;let r=(0,p.createServerClient)("https://pyppocnuyvkhyvcfrpmn.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5cHBvY251eXZraHl2Y2ZycG1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0OTgyMzIsImV4cCI6MjA2NjA3NDIzMn0.fXehDkuFNbITB_82vgRYH1x7JiNcozN5JNtFRKyIDMQ",{cookies:{get:r=>e.cookies.get(r)?.value,set(e,r,t){},remove(e,r){}}}),{data:{session:t},error:a}=await r.auth.getSession();return{session:t,error:a}}async function h(e){try{let r=({validateHeaders:e=>{let r=e.headers,t=r.get("content-type");if(t&&!t.includes("multipart/form-data"))return{isValid:!1,error:"只支持multipart/form-data格式"};let a=r.get("user-agent");if(!a||a.length>500)return{isValid:!1,error:"无效的User-Agent"};let i=r.get("content-length");return i&&parseInt(i)>0xa00000?{isValid:!1,error:"请求体过大"}:{isValid:!0}}}).validateHeaders(e);if(!r.isValid)return(0,c.h4)("invalid_headers",{error:r.error,ip:await d(e),path:"/api/remove-watermark"}),(0,c.WX)(r.error,400,e);let{session:t,error:a}=await f(e);if(a||!t||!t.user?.email)return(0,c.h4)("unauthorized_access",{path:"/api/remove-watermark",ip:await d(e),error:a?.message}),(0,c.WX)("Not authenticated",401,e);let i=t.user.email;(0,c.h4)("api_access",{userId:i,endpoint:"/api/remove-watermark",ip:await d(e)});let n=new Date().toISOString().slice(0,10),s=m.get(i);if(s&&s.date===n)if(s.count>=10)return(0,c.h4)("rate_limit_exceeded",{userId:i,endpoint:"/api/remove-watermark",currentCount:s.count,limit:10}),(0,c.WX)("Daily free limit reached",429,e);else s.count++,m.set(i,s);else m.set(i,{date:n,count:1});let p=(await e.formData()).get("image");if(!p)return(0,c.WX)("No image uploaded",400,e);try{if(!(0,l.U_)(p.name))throw(0,c.h4)("suspicious_filename",{userId:i,filename:p.name,ip:await d(e)}),new c.eI("文件名包含危险字符",p.name);let r=(0,l.TT)(p,l.Mz);if(!r.isValid)throw(0,c.h4)("invalid_file_upload",{userId:i,filename:p.name,errors:r.errors,ip:await d(e)}),new c.eI(`文件验证失败: ${r.errors.join(", ")}`,p.name);let t=await p.arrayBuffer();if(!(0,l.op)(t))throw(0,c.h4)("invalid_image_content",{userId:i,filename:p.name,size:t.byteLength,ip:await d(e)}),new c.eI("无效的图片文件内容",p.name)}catch(r){if(r instanceof c.eI)return(0,c.WX)(r.message,400,e);throw r}let h=await (0,u.U)("remove",p);return(0,c.h4)("image_processed_successfully",{userId:i,filename:p.name,fileSize:p.size,resultUrl:h.substring(0,50)+"..."}),o.NextResponse.json({resultUrl:h,remaining:10-m.get(i).count})}catch(r){if((0,c.h4)("api_error",{endpoint:"/api/remove-watermark",error:r instanceof Error?r.message:String(r),ip:await d(e)}),r instanceof c.eI)return(0,c.WX)(r.message,400,e);return(0,c.WX)(r instanceof Error?r.message:"Internal server error",500,e)}}let g=new i.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/remove-watermark/route",pathname:"/api/remove-watermark",filename:"route",bundlePath:"app/api/remove-watermark/route"},resolvedPagePath:"/Users/tutu/Desktop/Be a Developer/my-ai-tool-project/src/app/api/remove-watermark/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:w,workUnitAsyncStorage:v,serverHooks:x}=g;function y(){return(0,s.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:v})}},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[447,199,345,386,697,502],()=>t(75502));module.exports=a})();