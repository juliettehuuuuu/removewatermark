"use strict";(()=>{var e={};e.id=792,e.ids=[792],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{e.exports=require("punycode")},27910:e=>{e.exports=require("stream")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{e.exports=require("tls")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},64889:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>y,routeModule:()=>f,serverHooks:()=>v,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>w});var a={};t.r(a),t.d(a,{POST:()=>g});var i=t(96559),n=t(48088),s=t(37719),o=t(32190),u=t(64216),p=t(34386),c=t(11288),l=t(45558);let d=new Map;async function m(e){try{let r=e.headers.get("x-forwarded-for"),t=e.headers.get("x-real-ip"),a=e.headers.get("cf-connecting-ip"),i=e.headers.get("x-client-ip");if(a)return a;if(t)return t;if(r)return r.split(",")[0].trim();if(i)return i;return"unknown"}catch{return"unknown"}}async function h(e){new Response;let r=(0,p.createServerClient)("https://pyppocnuyvkhyvcfrpmn.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5cHBvY251eXZraHl2Y2ZycG1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0OTgyMzIsImV4cCI6MjA2NjA3NDIzMn0.fXehDkuFNbITB_82vgRYH1x7JiNcozN5JNtFRKyIDMQ",{cookies:{get:r=>e.cookies.get(r)?.value,set(e,r,t){},remove(e,r){}}}),{data:{session:t},error:a}=await r.auth.getSession();return{session:t,error:a}}async function g(e){try{let r=({validateHeaders:e=>{let r=e.headers,t=r.get("content-type");if(t&&!t.includes("multipart/form-data"))return{isValid:!1,error:"只支持multipart/form-data格式"};let a=r.get("user-agent");if(!a||a.length>500)return{isValid:!1,error:"无效的User-Agent"};let i=r.get("content-length");return i&&parseInt(i)>0xa00000?{isValid:!1,error:"请求体过大"}:{isValid:!0}}}).validateHeaders(e);if(!r.isValid)return(0,l.h4)("invalid_headers",{error:r.error,ip:await m(e),path:"/api/enhance-image"}),(0,l.WX)(r.error,400,e);let{session:t,error:a}=await h(e);if(a||!t||!t.user?.email)return(0,l.h4)("unauthorized_access",{path:"/api/enhance-image",ip:await m(e),error:a?.message}),(0,l.WX)("Not authenticated",401,e);let i=t.user.email;(0,l.h4)("api_access",{userId:i,endpoint:"/api/enhance-image",ip:await m(e)});let n=new Date().toISOString().slice(0,10),s=d.get(i);if(s&&s.date===n)if(s.count>=10)return(0,l.h4)("rate_limit_exceeded",{userId:i,endpoint:"/api/enhance-image",currentCount:s.count,limit:10}),(0,l.WX)("Daily free limit reached",429,e);else s.count++,d.set(i,s);else d.set(i,{date:n,count:1});let p=(await e.formData()).get("image");if(!p)return(0,l.WX)("No image uploaded",400,e);try{if(!(0,c.U_)(p.name))throw(0,l.h4)("suspicious_filename",{userId:i,filename:p.name,ip:await m(e)}),new l.eI("文件名包含危险字符",p.name);let r=(0,c.TT)(p,c.Mz);if(!r.isValid)throw(0,l.h4)("invalid_file_upload",{userId:i,filename:p.name,errors:r.errors,ip:await m(e)}),new l.eI(`文件验证失败: ${r.errors.join(", ")}`,p.name);let t=await p.arrayBuffer();if(!(0,c.op)(t))throw(0,l.h4)("invalid_image_content",{userId:i,filename:p.name,size:t.byteLength,ip:await m(e)}),new l.eI("无效的图片文件内容",p.name)}catch(r){if(r instanceof l.eI)return(0,l.WX)(r.message,400,e);throw r}let g=await (0,u.U)("enhance",p);return(0,l.h4)("image_processed_successfully",{userId:i,filename:p.name,fileSize:p.size,resultUrl:g.substring(0,50)+"..."}),o.NextResponse.json({resultUrl:g,remaining:10-d.get(i).count})}catch(r){if((0,l.h4)("api_error",{endpoint:"/api/enhance-image",error:r instanceof Error?r.message:String(r),ip:await m(e)}),r instanceof l.eI)return(0,l.WX)(r.message,400,e);return(0,l.WX)(r instanceof Error?r.message:"Internal server error",500,e)}}let f=new i.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/enhance-image/route",pathname:"/api/enhance-image",filename:"route",bundlePath:"app/api/enhance-image/route"},resolvedPagePath:"/Users/tutu/Desktop/Be a Developer/my-ai-tool-project/src/app/api/enhance-image/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:x,workUnitAsyncStorage:w,serverHooks:v}=f;function y(){return(0,s.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:w})}},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[447,199,345,386,697,502],()=>t(64889));module.exports=a})();